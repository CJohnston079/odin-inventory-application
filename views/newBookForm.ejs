<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Inventory | <%= title %></title>
		<link rel="stylesheet" href="../styles/index.css" />
	</head>
	<body>
		<%- include("partials/header", { backAnchor: true }) %>
		<h2><%= title %></h2>
		<form action="/books" method="post" id="new-book">
			<ul>
				<li>
					<label for="title">Book title:</label>
					<input type="text" name="title" id="title" required />
				</li>
				<li>
					<label for="author">Author:</label>
					<input type="text" name="author" id="author" required />
					<ul id="author-suggestions"></ul>
				</li>
				<li>
					<label for="genres">Genre(s):</label>
					<input type="text" name="genres" id="genres" />
					<ul id="genre-suggestions"></ul>
				</li>
				<li>
					<label for="publication-year">Publication year:</label>
					<input
						type="number"
						name="publication-year"
						id="publication-year"
						max="<%= new Date().getFullYear() %>"
					/>
				</li>
				<li>
					<input type="radio" id="fiction" name="isFiction" value="true" checked />
					<label for="fiction">Fiction</label>
					<input type="radio" id="non-fiction" name="isFiction" value="false" />
					<label for="non-fiction">Non-fiction</label>
				</li>
			</ul>
			<button type="submit">Add book</button>
		</form>
	</body>
	<script type="application/json" id="authorsData">
		<%- JSON.stringify(authors) %>
	</script>
	<script type="application/json" id="genresData">
		<%- JSON.stringify(genres) %>
	</script>
	<script type="module">
		import enableAutoComplete from "../scripts/enableAutoComplete.js";
		import enableAutoCompleteMulti from "../scripts/enableAutoCompleteMulti.js";
		import { validateAuthor, validateGenres } from "../scripts/validateInputs.js";

		const authors = JSON.parse(document.getElementById("authorsData").textContent);
		const genres = JSON.parse(document.getElementById("genresData").textContent);

		enableAutoComplete({
			inputElementID: "author",
			suggestionListID: "author-suggestions",
			options: authors,
			fieldName: "name",
			addNewRoute: "authors",
		});
		enableAutoCompleteMulti({
			inputElementID: "genres",
			suggestionListID: "genre-suggestions",
			options: genres,
			fieldName: "genre_name",
			addNewRoute: "genres",
		});

		document.querySelector("#new-book").addEventListener("submit", e => {
			const authorInput = document.querySelector("#author");
			const genresInput = document.querySelector("#genres");

			const authorError = validateAuthor(
				authorInput.value,
				authors.map(author => author.name)
			);

			const genresError = validateGenres(
				genresInput.value,
				genres.map(genre => genre.genre_name)
			);

			if (authorError) {
				e.preventDefault();
				alert(authorError);
			}

			if (genresError) {
				e.preventDefault();
				alert(genresError);
			}
		});
	</script>
</html>
